# Template file for 'signalhound-spike'
pkgname=signalhound-spike
version=4.0.5
revision=1
archs="x86_64"
build_style=fetch
hostmakedepends="unzip"
#makedepends=""
depends="libusb icu-libs qt5-dbus qt5-printsupport libcrypto1.1 qt5-gui
 qt5-serialport mesa qt5-core qt5-multimedia qt5-network qt5-opengl
 qt5-widgets libssl1.1 libxcb libssl1.1"
short_desc="Spectrum analyzer software for Signal Hound test equipment"
maintainer="fklose <felix.f.klose@gmail.com>"
license="GPL-3.0-or-later"
homepage="https://signalhound.com/spike/"
changelog="https://signalhound.com/sigdownloads/Spike/change_log.txt"
# distfiles="https://signalhound.com/sigdownloads/Spike/Spike(Ubuntu22.04x64)_4_0_5.zip"
# checksum=da0e88dc10eafc5a8979682dfa6bafe3e680c5e067010b85757d3c86e56bacdf
# QUESTION: Maybe I use the RHEL install since it does not depend on the matlab runtime
distfiles="https://signalhound.com/sigdownloads/Spike/Spike(RHEL8x64)_4_0_5.zip"
checksum=ed690dc6dda0d145b2091cdbea2fe638b918550934af6514f4fce58219a4642d
nopie=yes

# TODO: Looks like I need to package the matlab runtime otherwise xbps will complain
# TODO: I should probably install the package in /opt?
do_install() {
	echo "--->>> In do_install() ..."
	echo $(pwd)
	echo $(ls)
	# unzip ${wrksrc}/"Spike(Ubuntu22.04x64)_4_0_5.zip"
	unzip ${wrksrc}/"Spike(RHEL8x64)_4_0_5.zip"

	# spike_path=${wrksrc}/"Spike(Ubuntu22.04x64)_4_0_5"
	spike_path=${wrksrc}/"Spike(RHEL8x64)_4_0_5"

	# Install application binaries
	vmkdir /usr/lib/signalhound-spike 755
	vcopy ${spike_path}/* /usr/lib/signalhound-spike
	chmod +x ${PKGDESTDIR}/usr/lib/signalhound-spike/Spike
	chmod +x ${PKGDESTDIR}/usr/lib/signalhound-spike/bin/Spike

	# Place symlink in /usr/bin
	vmkdir /usr/bin
	ln -s /usr/lib/signalhound-spike/bin/Spike ${PKGDESTDIR}/usr/bin

	# Clean up the folder we just put in /usr/lib
	rm -r ${PKGDESTDIR}/usr/lib/signalhound-spike/assets # This contains desktop icons
	rm ${PKGDESTDIR}/usr/lib/signalhound-spike/sh.rules # These are the udev rules
	rm ${PKGDESTDIR}/usr/lib/signalhound-spike/com.signalhound.spike.desktop # This is the .desktop file
	rm ${PKGDESTDIR}/usr/lib/signalhound-spike/setup.sh # This is the setup script
	rm ${PKGDESTDIR}/usr/lib/signalhound-spike/Spike # From what I can gather this just runs the program in ./bin

	# Install udev rules
	vmkdir /usr/lib/udev/rules.d
	vcopy ${spike_path}/sh.rules /usr/lib/udev/rules.d/99-signalhound-spike.rules

	# Install the desktop icon
	vmkdir /usr/share/icons/hicolor/256x256/apps
	vcopy ${spike_path}/assets/com.signalhound.spike.png /usr/share/icons/hicolor/256x256/apps/signalhound-spike.png

	# Install the .desktop file
	vmkdir /usr/share/applications
	vcopy ${FILESDIR}/signalhound-spike.desktop /usr/share/applications

	# Install libGLDispatch which I somehow cannot get
	# vcopy ${FILESDIR}/lib* /usr/lib/signalhound-spike/lib
}
